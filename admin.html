import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const pendingMemorialsList = document.getElementById("pendingMemorialsList");
const pendingPartnersList = document.getElementById("pendingPartnersList");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Πρέπει να συνδεθείτε ως διαχειριστής.");
    window.location.href = "login.html";
    return;
  }

  const userDoc = await getDocs(query(collection(db, "users"), where("uid", "==", user.uid)));
  let isAdmin = false;
  userDoc.forEach((doc) => {
    if (doc.data().role === "admin") isAdmin = true;
  });

  if (!isAdmin) {
    alert("Δεν έχετε πρόσβαση σε αυτόν τον πίνακα.");
    window.location.href = "index.html";
    return;
  }

  loadPendingMemorials();
  loadPendingPartners();
});

async function loadPendingMemorials() {
  const q = query(collection(db, "memorials"), where("approved", "==", false));
  const snapshot = await getDocs(q);
  snapshot.forEach((docSnap) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${docSnap.data().fullName}</strong>
      <button onclick="approveMemorial('${docSnap.id}')">✅ Έγκριση</button>
      <button onclick="rejectMemorial('${docSnap.id}')">❌ Απόρριψη</button>
    `;
    pendingMemorialsList.appendChild(li);
  });
}

async function loadPendingPartners() {
  const q = query(collection(db, "users"), where("role", "==", "partner"), where("approved", "==", false));
  const snapshot = await getDocs(q);
  snapshot.forEach((docSnap) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${docSnap.data().email}</strong>
      <button onclick="approvePartner('${docSnap.id}')">✅ Έγκριση</button>
      <button onclick="rejectPartner('${docSnap.id}')">❌ Απόρριψη</button>
    `;
    pendingPartnersList.appendChild(li);
  });
}

window.approveMemorial = async function (id) {
  await updateDoc(doc(db, "memorials", id), { approved: true });
  alert("Το memorial εγκρίθηκε.");
  location.reload();
};

window.rejectMemorial = async function (id) {
  await updateDoc(doc(db, "memorials", id), { approved: false });
  alert("Το memorial απορρίφθηκε.");
  location.reload();
};

window.approvePartner = async function (id) {
  await updateDoc(doc(db, "users", id), { approved: true });
  alert("Ο συνεργάτης εγκρίθηκε.");
  location.reload();
};

window.rejectPartner = async function (id) {
  await updateDoc(doc(db, "users", id), { approved: false });
  alert("Ο συνεργάτης απορρίφθηκε.");
  location.reload();
};
